{"version":3,"file":"events.js","sources":["../src/sdk/events.ts","../src/sdk/options.ts","../src/sdk/track.ts","../src/utils/parse.ts"],"sourcesContent":["import parse from '../utils/parse';\nimport { IDropOptions, ILogger } from './interfaces';\nimport { makeWithOptions } from './options';\nimport { makeTrackEvent } from './track';\n\ninterface ICoinTrackerDeps {\n  w: any;\n  withOptions: ReturnType<typeof makeWithOptions>;\n  trackEvent: ReturnType<typeof makeTrackEvent>;\n}\n\nfunction makeCoinTracker({ w, withOptions, trackEvent }: ICoinTrackerDeps) {\n  function push(options: IDropOptions) {\n    if (options.__tracked) return;\n    trackEvent(withOptions(options));\n    options.__tracked = true;\n    originalPush(options);\n  }\n\n  w.coinTracker = w.coinTracker || [];\n  const originalPush = w.coinTracker.push.bind(w.coinTracker);\n  w.coinTracker.push = push;\n  w.coinTracker.forEach(push);\n  return w.coinTracker;\n}\n\nconst w = window;\nconst d = document;\nconst apiUri = 'https://tracking.coinapp.co';\nconst logger: ILogger = (...v) => console.log('COIN Tracker', ...v);\nconst withOptions = makeWithOptions({ w, d, logger, parser: parse });\nconst trackEvent = makeTrackEvent({ w, d, apiUri, logger });\n\nexport const coinTracker = makeCoinTracker({\n  w,\n  withOptions,\n  trackEvent,\n});\n\nexport const forEach = coinTracker.forEach.bind(coinTracker);\nexport const push = coinTracker.push.bind(coinTracker);\n","import { IDropOptions, IParser, ILogger } from './interfaces';\n\nexport function makeWithOptions({\n  d,\n  w,\n  parser,\n  logger,\n}: {\n  d: typeof document;\n  w: typeof window;\n  parser: IParser;\n  logger: ILogger;\n}) {\n  const fromCookie = parser(d.cookie); // From cookie\n  const fromQuery = parser(w.location.search.replace(/^\\?/, '')); // From query string\n  logger({ fromCookie, fromQuery });\n  return function (opts?: IDropOptions) {\n    return { ...fromCookie, ...fromQuery, ...opts };\n  };\n}\n","import { IDropOptions, ILogger } from './interfaces';\n\nexport function makeTrackEvent({\n  d,\n  apiUri,\n  logger,\n}: {\n  w: typeof window;\n  d: typeof document;\n  apiUri: string;\n  logger: ILogger;\n}) {\n  function appendChild(element: Element) {\n    if (d.body) {\n      d.body.appendChild(element);\n    } else {\n      d.addEventListener('readystatechange', () => appendChild(element));\n    }\n  }\n\n  function appendImgPixel(src: string) {\n    const img = d.createElement('img');\n    img.style.position = 'absolute';\n    img.style.top = '-1000px';\n    img.style.left = '-1000px';\n    img.style.opacity = '0';\n    img.src = src;\n    appendChild(img);\n  }\n\n  function addLinkClickPixel(opts: IDropOptions) {\n    if (opts.drop_id) {\n      appendImgPixel(`${apiUri}/drop/click/${opts.drop_id}`);\n    }\n  }\n\n  function addConversionPixel(opts: IDropOptions) {\n    if (opts.drop_id) {\n      appendImgPixel(`${apiUri}/drop/convert/${opts.drop_id}`);\n    }\n  }\n\n  return function (opts?: IDropOptions) {\n    if (!opts) return;\n    logger('Track event', opts);\n    switch (opts && opts.event) {\n      case 'click':\n        return addLinkClickPixel(opts);\n      case 'convert':\n        return addConversionPixel(opts);\n    }\n  };\n}\n","export default function parse(str: string) {\n  if (!str) return {};\n  return str\n    .split(/&|;/g)\n    .map(v => v.split('='))\n    .reduce((params: any, entry) => {\n      params[entry[0]] = entry[1];\n      return params;\n    },      {});\n}\n"],"names":["logger","_i","v","console","log","_a","d","w","parser","fromCookie","fromQuery","apiUri","window","document","appendImgPixel","src","img","createElement","style","position","top","left","opacity","appendChild","element","body","addEventListener","coinTracker","withOptions","trackEvent","push","options","__tracked","originalPush","bind","forEach","makeCoinTracker","str","split","map","reduce","params","entry","cookie","location","search","replace","opts","event","drop_id","addLinkClickPixel","addConversionPixel"],"mappings":"4PA6BwB,SAAlBA,QAAmB,aAAAC,mBAAAA,IAAAC,kBAAS,OAAAC,QAAQC,UAARD,SAAY,uBAAmBD,IAHjE,ICxBgCG,EAC9BC,EACAC,EACAC,EACAR,EAOMS,EACAC,ECZuBL,EAC7BC,EACAK,EACAX,EFqBIO,EAAIK,OACJN,EAAIO,SEPR,SAASC,EAAeC,GACtB,IAAMC,EAAMV,EAAEW,cAAc,OAC5BD,EAAIE,MAAMC,SAAW,WACrBH,EAAIE,MAAME,IAAM,UAChBJ,EAAIE,MAAMG,KAAO,UACjBL,EAAIE,MAAMI,QAAU,IACpBN,EAAID,IAAMA,EAdZ,SAASQ,EAAYC,GACflB,EAAEmB,KACJnB,EAAEmB,KAAKF,YAAYC,GAEnBlB,EAAEoB,iBAAiB,mBAAoB,WAAM,OAAAH,EAAYC,KAW3DD,CAAYP,OFMHW,EAtBb,SAAyBtB,OAAEE,MAAGqB,gBAAaC,eACzC,SAASC,EAAKC,GACRA,EAAQC,YACZH,EAAWD,EAAYG,IACvBA,EAAQC,WAAY,EACpBC,EAAaF,IAGfxB,EAAEoB,YAAcpB,EAAEoB,aAAe,GACjC,IAAMM,EAAe1B,EAAEoB,YAAYG,KAAKI,KAAK3B,EAAEoB,aAG/C,OAFApB,EAAEoB,YAAYG,KAAOA,EACrBvB,EAAEoB,YAAYQ,QAAQL,GACfvB,EAAEoB,YAUgBS,CAAgB,CACzC7B,IACAqB,aChCAtB,GAD8BD,ED4BI,CAAEE,IAAGD,IAAGN,SAAQQ,gBG9BtB6B,GAC5B,OAAKA,EACEA,EACJC,MAAM,QACNC,IAAI,SAAArC,GAAK,OAAAA,EAAEoC,MAAM,OACjBE,OAAO,SAACC,EAAaC,GAEpB,OADAD,EAAOC,EAAM,IAAMA,EAAM,GAClBD,GACD,IAPO,QFGjBlC,MACAC,WACAR,WAOMS,EAAaD,EAAOF,EAAEqC,QACtBjC,EAAYF,EAAOD,EAAEqC,SAASC,OAAOC,QAAQ,MAAO,KAC1D9C,EAAO,CAAES,aAAYC,cACd,SAAUqC,GACf,YAAYtC,EAAeC,EAAcqC,KDmB3ClB,YEjCAvB,GAD6BD,EF6BG,CAAEE,IAAGD,IAAGK,OAH3B,8BAGmCX,aE3BhDW,WACAX,WAqCO,SAAU+C,GACf,GAAKA,EAEL,OADA/C,EAAO,cAAe+C,GACdA,GAAQA,EAAKC,OACnB,IAAK,QACH,OAjBN,SAA2BD,GACrBA,EAAKE,SACPnC,EAAkBH,iBAAqBoC,EAAKE,SAenCC,CAAkBH,GAC3B,IAAK,UACH,OAbN,SAA4BA,GACtBA,EAAKE,SACPnC,EAAkBH,mBAAuBoC,EAAKE,SAWrCE,CAAmBJ,QFVrBZ,EAAUR,EAAYQ,QAAQD,KAAKP,GACnCG,EAAOH,EAAYG,KAAKI,KAAKP"}